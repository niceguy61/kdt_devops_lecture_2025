# ë¬¸ì œ 3: Event Sourcing ì´ë²¤íŠ¸ ì²˜ë¦¬ ì¤‘ë‹¨
# Event Storeì™€ Event Processorì˜ ì˜ë„ì  ì˜¤ë¥˜ë“¤

apiVersion: v1
kind: ConfigMap
metadata:
  name: event-store
  namespace: ecommerce-microservices
data:
  events.json: |
    {
      "events": [
        {
          "event_id": "evt-001",
          "aggregate_id": "user-123",
          "event_type": "UserCreated",
          "version": 1,
          "timestamp": "2024-01-01T10:00:00Z",
          "data": {"name": "John Doe", "email": "john@example.com"}
        },
        {
          "event_id": "evt-002",
          "aggregate_id": "user-123",
          "event_type": "UserUpdated",
          "version": 2,
          "timestamp": "2024-01-01T10:01:00Z",
          "data": {"email": "john.doe@example.com"}
        }
      ]
    }
---
# ì˜ë„ì  ì˜¤ë¥˜ 1: ì˜ëª»ëœ CronJob ìŠ¤ì¼€ì¤„ í‘œí˜„ì‹
apiVersion: batch/v1
kind: CronJob
metadata:
  name: event-processor
  namespace: ecommerce-microservices
spec:
  # ğŸ”§ FIX ME 1: CronJobì´ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (ìŠ¤ì¼€ì¤„ í˜•ì‹ ì˜¤ë¥˜)
  schedule: "*/5 * * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: event-processor
            image: busybox:1.35
            command: ['sh', '-c']
            args:
            - |
              echo "=== Event Processing Started ==="
              echo "Reading events from Event Store..."
              # ğŸ”§ FIX ME 2: ì´ë²¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
              cat /wrong-events/events.json || echo "Failed to read events"
              echo "=== Event Processing Failed ==="
            volumeMounts:
            - name: event-store
              mountPath: /events  # ìŠ¤í¬ë¦½íŠ¸ì—ì„œëŠ” /wrong-events ì°¸ì¡°
          volumes:
          - name: event-store
            configMap:
              name: event-store
          restartPolicy: OnFailure
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: event-store-api
  namespace: ecommerce-microservices
spec:
  replicas: 1
  selector:
    matchLabels:
      app: event-store-api
  template:
    metadata:
      labels:
        app: event-store-api
    spec:
      containers:
      - name: event-store-api
        image: nginx:1.25
        ports:
        - containerPort: 80
        volumeMounts:
        - name: eventstore-config
          mountPath: /etc/nginx/conf.d
        - name: event-data
          # ğŸ”§ FIX ME 3: APIê°€ ì´ë²¤íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
          mountPath: /usr/share/nginx/html/wrong-events
      volumes:
      - name: eventstore-config
        configMap:
          name: event-store-api-config
      - name: event-data
        configMap:
          name: event-store
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: event-store-api-config
  namespace: ecommerce-microservices
data:
  default.conf: |
    server {
        listen 80;
        location /api/events {
            # ğŸ”§ FIX ME 4: 404 Not Found ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤
            alias /usr/share/nginx/html/events/events.json;
            add_header Content-Type application/json;
        }
        location /api/events/replay {
            return 200 '{
                "replay_id": "replay-001",
                "status": "started",
                "events_count": 1000,
                "estimated_time": "30s"
            }';
            add_header Content-Type application/json;
        }
    }
---
apiVersion: v1
kind: Service
metadata:
  name: event-store-api
  namespace: ecommerce-microservices
spec:
  selector:
    app: event-store-api
  ports:
  - port: 80
    targetPort: 80
