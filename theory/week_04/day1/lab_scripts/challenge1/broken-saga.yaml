# ë¬¸ì œ 1: Saga íŒ¨í„´ íŠ¸ëœì­ì…˜ ì‹¤íŒ¨
# ì˜ë„ì  ì˜¤ë¥˜ë“¤ì´ í¬í•¨ëœ Saga êµ¬í˜„

apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: microservices-challenge
spec:
  replicas: 2
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
    spec:
      containers:
      - name: order-service
        image: nginx:1.25
        ports:
        - containerPort: 80
        volumeMounts:
        - name: service-config
          mountPath: /etc/nginx/conf.d
      volumes:
      - name: service-config
        configMap:
          name: order-service-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: order-service-config
  namespace: microservices-challenge
data:
  default.conf: |
    server {
        listen 80;
        # ğŸ”§ FIX ME 5: Nginx ì„¤ì • ë¬¸ë²• ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤
        location /api/orders {
            return 200 '{"service": "order-service", "action": "create_order", "saga_id": "saga-001", "status": "initiated"}'
            add_header Content-Type application/json;
        }
        location /api/orders/compensate {
            return 200 '{"service": "order-service", "action": "cancel_order", "saga_id": "saga-001", "status": "compensated"}';
            add_header Content-Type application/json;
        }
    }
---
apiVersion: v1
kind: Service
metadata:
  name: order-service
  namespace: microservices-challenge
spec:
  selector:
    app: order-service
  ports:
  - port: 80
    targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-service
  namespace: microservices-challenge
spec:
  replicas: 2
  selector:
    matchLabels:
      app: payment-service
  template:
    metadata:
      labels:
        app: payment-service
    spec:
      containers:
      - name: payment-service
        image: nginx:1.25
        ports:
        - containerPort: 80
        volumeMounts:
        - name: service-config
          mountPath: /etc/nginx/conf.d
      volumes:
      - name: service-config
        configMap:
          name: payment-service-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: payment-service-config
  namespace: microservices-challenge
data:
  default.conf: |
    server {
        listen 80;
        location /api/payments {
            return 200 '{"service": "payment-service", "action": "process_payment", "saga_id": "saga-001", "status": "completed", "amount": 100.00}';
            add_header Content-Type application/json;
        }
        location /api/payments/compensate {
            return 200 '{"service": "payment-service", "action": "refund_payment", "saga_id": "saga-001", "status": "refunded", "amount": 100.00}';
            add_header Content-Type application/json;
        }
    }
---
apiVersion: v1
kind: Service
metadata:
  name: payment-service
  namespace: microservices-challenge
spec:
  selector:
    app: payment-service
  ports:
  - port: 80
    targetPort: 80
---
# ì˜ë„ì  ì˜¤ë¥˜ 2: Saga Jobì˜ ì˜ëª»ëœ ì„¤ì •
apiVersion: batch/v1
kind: Job
metadata:
  name: saga-orchestrator
  namespace: microservices-challenge
spec:
  # ğŸ”§ FIX ME 1: Jobì´ ì¬ì‹œë„ë¥¼ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
  backoffLimit: 0
  template:
    spec:
      containers:
      - name: saga-orchestrator
        image: busybox:1.35
        command: ['sh', '-c']
        args:
        - |
          echo "=== Saga Transaction Started ==="
          echo "Step 1: Validate User"
          
          # ğŸ”§ FIX ME 2: ì„œë¹„ìŠ¤ URLì´ í•´ê²°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
          echo "Calling order service..."
          wget -q -O- http://wrong-order-service/api/orders || echo "Order service call failed"
          
          # ğŸ”§ FIX ME 3: íŠ¸ëœì­ì…˜ì´ ì‹¤íŒ¨ë¡œ í‘œì‹œë©ë‹ˆë‹¤
          echo "Step 2: Create Order - FAILED"
          echo "Step 3: Process Payment - SKIPPED"
          echo "=== Saga Transaction Failed ==="
          
          # ğŸ”§ FIX ME 4: Jobì´ í•­ìƒ ì‹¤íŒ¨í•©ë‹ˆë‹¤
          exit 1
      restartPolicy: Never
---
# ğŸš¨ ë¬¸ì œ 3: Saga Orchestrator ConfigMap (ì˜ëª»ëœ URL)
apiVersion: v1
kind: ConfigMap
metadata:
  name: saga-config
  namespace: microservices-challenge
data:
  ORDER_SERVICE_URL: "http://order-service/api/orders"  # ğŸš¨ FQDN ëˆ„ë½
  PAYMENT_SERVICE_URL: "http://payment-service.microservices-challenge.svc.cluster.local/api/payments"