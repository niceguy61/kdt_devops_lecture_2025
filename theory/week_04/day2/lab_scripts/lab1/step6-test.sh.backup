#!/bin/bash

# Step 6: í†µí•© í…ŒìŠ¤íŠ¸

echo "=== Step 6: í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘ ==="
echo ""

# istioctl PATH ì„¤ì •
if [ -d "istio-1.20.0" ]; then
    cd istio-1.20.0
    export PATH=$PWD/bin:$PATH
    cd ..
fi

# Ingress Gateway NodePort í™•ì¸
echo "1. Ingress Gateway í¬íŠ¸ í™•ì¸ ì¤‘..."
INGRESS_PORT=$(kubectl get svc -n istio-system istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')
echo "   Ingress NodePort: $INGRESS_PORT"

# ê¸°ë³¸ ë¼ìš°íŒ… í…ŒìŠ¤íŠ¸
echo ""
echo "2. ê¸°ë³¸ ë¼ìš°íŒ… í…ŒìŠ¤íŠ¸..."
echo ""
echo "User Service:"
curl -s http://localhost:$INGRESS_PORT/users
echo ""
echo ""
echo "Product Service:"
curl -s http://localhost:$INGRESS_PORT/products
echo ""
echo ""
echo "Order Service:"
curl -s http://localhost:$INGRESS_PORT/orders
echo ""

# ë¡œë“œë°¸ëŸ°ì‹± í…ŒìŠ¤íŠ¸
echo ""
echo "3. ë¡œë“œë°¸ëŸ°ì‹± í…ŒìŠ¤íŠ¸ (10íšŒ ìš”ì²­)..."
for i in {1..10}; do
  echo "Request $i:"
  curl -s http://localhost:$INGRESS_PORT/users
done

# Istio Proxy ìƒíƒœ í™•ì¸
echo ""
echo ""
echo "4. Istio Proxy ìƒíƒœ í™•ì¸..."
if command -v istioctl &> /dev/null; then
    istioctl proxy-status
else
    echo "   â„¹ï¸  istioctlì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
fi

echo ""
echo "=== Step 6: í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ ==="
echo ""
echo "ğŸ’¡ ì¶”ê°€ í…ŒìŠ¤íŠ¸ë¥¼ ì›í•˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:"
echo ""
echo "   # User Service"
echo "   curl http://localhost:$INGRESS_PORT/users"
echo ""
echo "   # Product Service"
echo "   curl http://localhost:$INGRESS_PORT/products"
echo ""
echo "   # Order Service"
echo "   curl http://localhost:$INGRESS_PORT/orders"
