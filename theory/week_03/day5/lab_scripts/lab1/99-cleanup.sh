#!/bin/bash

# Week 3 Day 5 Lab 1: μ •λ¦¬ μ¤ν¬λ¦½νΈ
# μ‚¬μ©λ²•: ./99-cleanup.sh

set -e

NAMESPACE="day5-lab"
CLUSTER_NAME="challenge-cluster"

echo "β•”β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•—"
echo "β•‘  Week 3 Day 5 Lab 1: ν™κ²½ μ •λ¦¬                           β•‘"
echo "β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•"
echo ""
echo "β οΈ  λ‹¤μ μ‘μ—…μ΄ μν–‰λ©λ‹λ‹¤:"
echo "   1. ν¬νΈν¬μ›λ”© μ¤‘μ§€"
echo "   2. kind ν΄λ¬μ¤ν„° μ™„μ „ μ‚­μ "
echo "   3. λ¨λ“  λ¦¬μ†μ¤ μ •λ¦¬"
echo ""

read -p "μ •λ§ μ‚­μ ν•μ‹κ² μµλ‹κΉ? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "μ •λ¦¬κ°€ μ·¨μ†λμ—μµλ‹λ‹¤."
    exit 1
fi

echo ""
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
echo "1. ν¬νΈν¬μ›λ”© μ¤‘μ§€"
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

# ν¬νΈν¬μ›λ”© μ¤‘μ§€ μ¤ν¬λ¦½νΈ μ‹¤ν–‰
if [ -f "./07-stop-portforward.sh" ]; then
    ./07-stop-portforward.sh
else
    # μλ™μΌλ΅ ν¬νΈν¬μ›λ”© ν”„λ΅μ„Έμ¤ μΆ…λ£
    pkill -f "port-forward.*monitoring" 2>/dev/null || true
    pkill -f "port-forward.*argocd" 2>/dev/null || true
    pkill -f "port-forward.*day5-lab" 2>/dev/null || true
    echo "β… ν¬νΈν¬μ›λ”© μ¤‘μ§€ μ™„λ£"
fi

echo ""
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
echo "2. kind ν΄λ¬μ¤ν„° μ‚­μ "
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

if command -v kind &> /dev/null; then
    if kind get clusters 2>/dev/null | grep -q "^${CLUSTER_NAME}$"; then
        echo "kind ν΄λ¬μ¤ν„° '$CLUSTER_NAME' μ‚­μ  μ¤‘..."
        kind delete cluster --name $CLUSTER_NAME
        echo "β… kind ν΄λ¬μ¤ν„° μ‚­μ  μ™„λ£"
    else
        echo "β„ΉοΈ  kind ν΄λ¬μ¤ν„° '$CLUSTER_NAME'κ°€ μ΅΄μ¬ν•μ§€ μ•μµλ‹λ‹¤."
    fi
else
    echo "β„ΉοΈ  kindκ°€ μ„¤μΉλμ–΄ μμ§€ μ•μµλ‹λ‹¤."
fi

echo ""
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
echo "3. μ„μ‹ νμΌ μ •λ¦¬"
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

# ν¬νΈν¬μ›λ”© PID λ””λ ‰ν† λ¦¬ μ‚­μ 
if [ -d "/tmp/day5-lab-portforward" ]; then
    rm -rf /tmp/day5-lab-portforward
    echo "β… μ„μ‹ νμΌ μ •λ¦¬ μ™„λ£"
fi

echo ""
echo "β•”β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•—"
echo "β•‘  π‰ μ •λ¦¬ μ™„λ£!                                            β•‘"
echo "β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•"
echo ""
echo "β… μ‚­μ λ λ¦¬μ†μ¤:"
echo "   - ν¬νΈν¬μ›λ”© ν”„λ΅μ„Έμ¤"
echo "   - kind ν΄λ¬μ¤ν„° ($CLUSTER_NAME)"
echo "   - λ¨λ“  Kubernetes λ¦¬μ†μ¤"
echo ""
echo "π’΅ μƒλ΅ μ‹μ‘ν•λ ¤λ©΄:"
echo "   ./00-install-all.sh"

echo ""
echo "β•”β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•—"
echo "β•‘  π‰ μ •λ¦¬ μ™„λ£!                                            β•‘"
echo "β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•β•"
echo ""
echo "β… μ‚­μ λ λ¦¬μ†μ¤:"
echo "   - ν¬νΈν¬μ›λ”© ν”„λ΅μ„Έμ¤"
echo "   - kind ν΄λ¬μ¤ν„° ($CLUSTER_NAME)"
echo "   - λ¨λ“  Kubernetes λ¦¬μ†μ¤"
echo ""
echo "π’΅ μƒλ΅ μ‹μ‘ν•λ ¤λ©΄:"
echo "   ./00-install-all.sh"
